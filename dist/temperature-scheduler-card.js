const t="undefined"!=typeof window&&null!=window.customElements&&void 0!==window.customElements.polyfillWrapFlushCallback,e=(t,e,s=null)=>{for(;e!==s;){const s=e.nextSibling;t.removeChild(e),e=s}},s=`{{lit-${String(Math.random()).slice(2)}}}`,i=`\x3c!--${s}--\x3e`,r=new RegExp(`${s}|${i}`),n="$lit$";class a{constructor(t,e){this.parts=[],this.element=e;const i=[],a=[],l=document.createTreeWalker(e.content,133,null,!1);let h=0,u=-1,p=0;const{strings:g,values:{length:y}}=t;for(;p<y;){const t=l.nextNode();if(null!==t){if(u++,1===t.nodeType){if(t.hasAttributes()){const e=t.attributes,{length:s}=e;let i=0;for(let t=0;t<s;t++)o(e[t].name,n)&&i++;for(;i-- >0;){const e=g[p],s=d.exec(e)[2],i=s.toLowerCase()+n,a=t.getAttribute(i);t.removeAttribute(i);const o=a.split(r);this.parts.push({type:"attribute",index:u,name:s,strings:o}),p+=o.length-1}}"TEMPLATE"===t.tagName&&(a.push(t),l.currentNode=t.content)}else if(3===t.nodeType){const e=t.data;if(e.indexOf(s)>=0){const s=t.parentNode,a=e.split(r),l=a.length-1;for(let e=0;e<l;e++){let i,r=a[e];if(""===r)i=c();else{const t=d.exec(r);null!==t&&o(t[2],n)&&(r=r.slice(0,t.index)+t[1]+t[2].slice(0,-5)+t[3]),i=document.createTextNode(r)}s.insertBefore(i,t),this.parts.push({type:"node",index:++u})}""===a[l]?(s.insertBefore(c(),t),i.push(t)):t.data=a[l],p+=l}}else if(8===t.nodeType)if(t.data===s){const e=t.parentNode;null!==t.previousSibling&&u!==h||(u++,e.insertBefore(c(),t)),h=u,this.parts.push({type:"node",index:u}),null===t.nextSibling?t.data="":(i.push(t),u--),p++}else{let e=-1;for(;-1!==(e=t.data.indexOf(s,e+1));)this.parts.push({type:"node",index:-1}),p++}}else l.currentNode=a.pop()}for(const t of i)t.parentNode.removeChild(t)}}const o=(t,e)=>{const s=t.length-e.length;return s>=0&&t.slice(s)===e},l=t=>-1!==t.index,c=()=>document.createComment(""),d=/([ \x09\x0a\x0c\x0d])([^\0-\x1F\x7F-\x9F "'>=/]+)([ \x09\x0a\x0c\x0d]*=[ \x09\x0a\x0c\x0d]*(?:[^ \x09\x0a\x0c\x0d"'`<>=]*|"[^"]*|'[^']*))$/;function h(t,e){const{element:{content:s},parts:i}=t,r=document.createTreeWalker(s,133,null,!1);let n=p(i),a=i[n],o=-1,l=0;const c=[];let d=null;for(;r.nextNode();){o++;const t=r.currentNode;for(t.previousSibling===d&&(d=null),e.has(t)&&(c.push(t),null===d&&(d=t)),null!==d&&l++;void 0!==a&&a.index===o;)a.index=null!==d?-1:a.index-l,n=p(i,n),a=i[n]}c.forEach(t=>t.parentNode.removeChild(t))}const u=t=>{let e=11===t.nodeType?0:1;const s=document.createTreeWalker(t,133,null,!1);for(;s.nextNode();)e++;return e},p=(t,e=-1)=>{for(let s=e+1;s<t.length;s++){const e=t[s];if(l(e))return s}return-1};const g=new WeakMap,y=t=>"function"==typeof t&&g.has(t),f={},m={};class w{constructor(t,e,s){this.__parts=[],this.template=t,this.processor=e,this.options=s}update(t){let e=0;for(const s of this.__parts)void 0!==s&&s.setValue(t[e]),e++;for(const t of this.__parts)void 0!==t&&t.commit()}_clone(){const e=t?this.template.element.content.cloneNode(!0):document.importNode(this.template.element.content,!0),s=[],i=this.template.parts,r=document.createTreeWalker(e,133,null,!1);let n,a=0,o=0,c=r.nextNode();for(;a<i.length;)if(n=i[a],l(n)){for(;o<n.index;)o++,"TEMPLATE"===c.nodeName&&(s.push(c),r.currentNode=c.content),null===(c=r.nextNode())&&(r.currentNode=s.pop(),c=r.nextNode());if("node"===n.type){const t=this.processor.handleTextExpression(this.options);t.insertAfterNode(c.previousSibling),this.__parts.push(t)}else this.__parts.push(...this.processor.handleAttributeExpressions(c,n.name,n.strings,this.options));a++}else this.__parts.push(void 0),a++;return t&&(document.adoptNode(e),customElements.upgrade(e)),e}}const v=window.trustedTypes&&trustedTypes.createPolicy("lit-html",{createHTML:t=>t}),S=` ${s} `;class _{constructor(t,e,s,i){this.strings=t,this.values=e,this.type=s,this.processor=i}getHTML(){const t=this.strings.length-1;let e="",r=!1;for(let a=0;a<t;a++){const t=this.strings[a],o=t.lastIndexOf("\x3c!--");r=(o>-1||r)&&-1===t.indexOf("--\x3e",o+1);const l=d.exec(t);e+=null===l?t+(r?S:i):t.substr(0,l.index)+l[1]+l[2]+n+l[3]+s}return e+=this.strings[t],e}getTemplateElement(){const t=document.createElement("template");let e=this.getHTML();return void 0!==v&&(e=v.createHTML(e)),t.innerHTML=e,t}}const P=t=>null===t||!("object"==typeof t||"function"==typeof t),x=t=>Array.isArray(t)||!(!t||!t[Symbol.iterator]);class b{constructor(t,e,s){this.dirty=!0,this.element=t,this.name=e,this.strings=s,this.parts=[];for(let t=0;t<s.length-1;t++)this.parts[t]=this._createPart()}_createPart(){return new C(this)}_getValue(){const t=this.strings,e=t.length-1,s=this.parts;if(1===e&&""===t[0]&&""===t[1]){const t=s[0].value;if("symbol"==typeof t)return String(t);if("string"==typeof t||!x(t))return t}let i="";for(let r=0;r<e;r++){i+=t[r];const e=s[r];if(void 0!==e){const t=e.value;if(P(t)||!x(t))i+="string"==typeof t?t:String(t);else for(const e of t)i+="string"==typeof e?e:String(e)}}return i+=t[e],i}commit(){this.dirty&&(this.dirty=!1,this.element.setAttribute(this.name,this._getValue()))}}class C{constructor(t){this.value=void 0,this.committer=t}setValue(t){t===f||P(t)&&t===this.value||(this.value=t,y(t)||(this.committer.dirty=!0))}commit(){for(;y(this.value);){const t=this.value;this.value=f,t(this)}this.value!==f&&this.committer.commit()}}class E{constructor(t){this.value=void 0,this.__pendingValue=void 0,this.options=t}appendInto(t){this.startNode=t.appendChild(c()),this.endNode=t.appendChild(c())}insertAfterNode(t){this.startNode=t,this.endNode=t.nextSibling}appendIntoPart(t){t.__insert(this.startNode=c()),t.__insert(this.endNode=c())}insertAfterPart(t){t.__insert(this.startNode=c()),this.endNode=t.endNode,t.endNode=this.startNode}setValue(t){this.__pendingValue=t}commit(){if(null===this.startNode.parentNode)return;for(;y(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=f,t(this)}const t=this.__pendingValue;t!==f&&(P(t)?t!==this.value&&this.__commitText(t):t instanceof _?this.__commitTemplateResult(t):t instanceof Node?this.__commitNode(t):x(t)?this.__commitIterable(t):t===m?(this.value=m,this.clear()):this.__commitText(t))}__insert(t){this.endNode.parentNode.insertBefore(t,this.endNode)}__commitNode(t){this.value!==t&&(this.clear(),this.__insert(t),this.value=t)}__commitText(t){const e=this.startNode.nextSibling,s="string"==typeof(t=null==t?"":t)?t:String(t);e===this.endNode.previousSibling&&3===e.nodeType?e.data=s:this.__commitNode(document.createTextNode(s)),this.value=t}__commitTemplateResult(t){const e=this.options.templateFactory(t);if(this.value instanceof w&&this.value.template===e)this.value.update(t.values);else{const s=new w(e,t.processor,this.options),i=s._clone();s.update(t.values),this.__commitNode(i),this.value=s}}__commitIterable(t){Array.isArray(this.value)||(this.value=[],this.clear());const e=this.value;let s,i=0;for(const r of t)s=e[i],void 0===s&&(s=new E(this.options),e.push(s),0===i?s.appendIntoPart(this):s.insertAfterPart(e[i-1])),s.setValue(r),s.commit(),i++;i<e.length&&(e.length=i,this.clear(s&&s.endNode))}clear(t=this.startNode){e(this.startNode.parentNode,t.nextSibling,this.endNode)}}class A{constructor(t,e,s){if(this.value=void 0,this.__pendingValue=void 0,2!==s.length||""!==s[0]||""!==s[1])throw new Error("Boolean attributes can only contain a single expression");this.element=t,this.name=e,this.strings=s}setValue(t){this.__pendingValue=t}commit(){for(;y(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=f,t(this)}if(this.__pendingValue===f)return;const t=!!this.__pendingValue;this.value!==t&&(t?this.element.setAttribute(this.name,""):this.element.removeAttribute(this.name),this.value=t),this.__pendingValue=f}}class M extends b{constructor(t,e,s){super(t,e,s),this.single=2===s.length&&""===s[0]&&""===s[1]}_createPart(){return new D(this)}_getValue(){return this.single?this.parts[0].value:super._getValue()}commit(){this.dirty&&(this.dirty=!1,this.element[this.name]=this._getValue())}}class D extends C{}let $=!1;(()=>{try{const t={get capture(){return $=!0,!1}};window.addEventListener("test",t,t),window.removeEventListener("test",t,t)}catch(t){}})();class I{constructor(t,e,s){this.value=void 0,this.__pendingValue=void 0,this.element=t,this.eventName=e,this.eventContext=s,this.__boundHandleEvent=t=>this.handleEvent(t)}setValue(t){this.__pendingValue=t}commit(){for(;y(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=f,t(this)}if(this.__pendingValue===f)return;const t=this.__pendingValue,e=this.value,s=null==t||null!=e&&(t.capture!==e.capture||t.once!==e.once||t.passive!==e.passive),i=null!=t&&(null==e||s);s&&this.element.removeEventListener(this.eventName,this.__boundHandleEvent,this.__options),i&&(this.__options=k(t),this.element.addEventListener(this.eventName,this.__boundHandleEvent,this.__options)),this.value=t,this.__pendingValue=f}handleEvent(t){"function"==typeof this.value?this.value.call(this.eventContext||this.element,t):this.value.handleEvent(t)}}const k=t=>t&&($?{capture:t.capture,passive:t.passive,once:t.once}:t.capture);function N(t){let e=T.get(t.type);void 0===e&&(e={stringsArray:new WeakMap,keyString:new Map},T.set(t.type,e));let i=e.stringsArray.get(t.strings);if(void 0!==i)return i;const r=t.strings.join(s);return i=e.keyString.get(r),void 0===i&&(i=new a(t,t.getTemplateElement()),e.keyString.set(r,i)),e.stringsArray.set(t.strings,i),i}const T=new Map,R=new WeakMap;const U=new class{handleAttributeExpressions(t,e,s,i){const r=e[0];if("."===r){return new M(t,e.slice(1),s).parts}if("@"===r)return[new I(t,e.slice(1),i.eventContext)];if("?"===r)return[new A(t,e.slice(1),s)];return new b(t,e,s).parts}handleTextExpression(t){return new E(t)}};"undefined"!=typeof window&&(window.litHtmlVersions||(window.litHtmlVersions=[])).push("1.4.1");const V=(t,...e)=>new _(t,e,"html",U),L=(t,e)=>`${t}--${e}`;let O=!0;void 0===window.ShadyCSS?O=!1:void 0===window.ShadyCSS.prepareTemplateDom&&(console.warn("Incompatible ShadyCSS version detected. Please update to at least @webcomponents/webcomponentsjs@2.0.2 and @webcomponents/shadycss@1.3.1."),O=!1);const H=t=>e=>{const i=L(e.type,t);let r=T.get(i);void 0===r&&(r={stringsArray:new WeakMap,keyString:new Map},T.set(i,r));let n=r.stringsArray.get(e.strings);if(void 0!==n)return n;const o=e.strings.join(s);if(n=r.keyString.get(o),void 0===n){const s=e.getTemplateElement();O&&window.ShadyCSS.prepareTemplateDom(s,t),n=new a(e,s),r.keyString.set(o,n)}return r.stringsArray.set(e.strings,n),n},B=["html","svg"],z=new Set,F=(t,e,s)=>{z.add(t);const i=s?s.element:document.createElement("template"),r=e.querySelectorAll("style"),{length:n}=r;if(0===n)return void window.ShadyCSS.prepareTemplateStyles(i,t);const a=document.createElement("style");for(let t=0;t<n;t++){const e=r[t];e.parentNode.removeChild(e),a.textContent+=e.textContent}(t=>{B.forEach(e=>{const s=T.get(L(e,t));void 0!==s&&s.keyString.forEach(t=>{const{element:{content:e}}=t,s=new Set;Array.from(e.querySelectorAll("style")).forEach(t=>{s.add(t)}),h(t,s)})})})(t);const o=i.content;s?function(t,e,s=null){const{element:{content:i},parts:r}=t;if(null==s)return void i.appendChild(e);const n=document.createTreeWalker(i,133,null,!1);let a=p(r),o=0,l=-1;for(;n.nextNode();)for(l++,n.currentNode===s&&(o=u(e),s.parentNode.insertBefore(e,s));-1!==a&&r[a].index===l;){if(o>0){for(;-1!==a;)r[a].index+=o,a=p(r,a);return}a=p(r,a)}}(s,a,o.firstChild):o.insertBefore(a,o.firstChild),window.ShadyCSS.prepareTemplateStyles(i,t);const l=o.querySelector("style");if(window.ShadyCSS.nativeShadow&&null!==l)e.insertBefore(l.cloneNode(!0),e.firstChild);else if(s){o.insertBefore(a,o.firstChild);const t=new Set;t.add(a),h(s,t)}};window.JSCompiler_renameProperty=(t,e)=>t;const j={toAttribute(t,e){switch(e){case Boolean:return t?"":null;case Object:case Array:return null==t?t:JSON.stringify(t)}return t},fromAttribute(t,e){switch(e){case Boolean:return null!==t;case Number:return null===t?null:Number(t);case Object:case Array:return JSON.parse(t)}return t}},q=(t,e)=>e!==t&&(e==e||t==t),W={attribute:!0,type:String,converter:j,reflect:!1,hasChanged:q},K="finalized";class J extends HTMLElement{constructor(){super(),this.initialize()}static get observedAttributes(){this.finalize();const t=[];return this._classProperties.forEach((e,s)=>{const i=this._attributeNameForProperty(s,e);void 0!==i&&(this._attributeToPropertyMap.set(i,s),t.push(i))}),t}static _ensureClassProperties(){if(!this.hasOwnProperty(JSCompiler_renameProperty("_classProperties",this))){this._classProperties=new Map;const t=Object.getPrototypeOf(this)._classProperties;void 0!==t&&t.forEach((t,e)=>this._classProperties.set(e,t))}}static createProperty(t,e=W){if(this._ensureClassProperties(),this._classProperties.set(t,e),e.noAccessor||this.prototype.hasOwnProperty(t))return;const s="symbol"==typeof t?Symbol():`__${t}`,i=this.getPropertyDescriptor(t,s,e);void 0!==i&&Object.defineProperty(this.prototype,t,i)}static getPropertyDescriptor(t,e,s){return{get(){return this[e]},set(i){const r=this[t];this[e]=i,this.requestUpdateInternal(t,r,s)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this._classProperties&&this._classProperties.get(t)||W}static finalize(){const t=Object.getPrototypeOf(this);if(t.hasOwnProperty(K)||t.finalize(),this[K]=!0,this._ensureClassProperties(),this._attributeToPropertyMap=new Map,this.hasOwnProperty(JSCompiler_renameProperty("properties",this))){const t=this.properties,e=[...Object.getOwnPropertyNames(t),..."function"==typeof Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(t):[]];for(const s of e)this.createProperty(s,t[s])}}static _attributeNameForProperty(t,e){const s=e.attribute;return!1===s?void 0:"string"==typeof s?s:"string"==typeof t?t.toLowerCase():void 0}static _valueHasChanged(t,e,s=q){return s(t,e)}static _propertyValueFromAttribute(t,e){const s=e.type,i=e.converter||j,r="function"==typeof i?i:i.fromAttribute;return r?r(t,s):t}static _propertyValueToAttribute(t,e){if(void 0===e.reflect)return;const s=e.type,i=e.converter;return(i&&i.toAttribute||j.toAttribute)(t,s)}initialize(){this._updateState=0,this._updatePromise=new Promise(t=>this._enableUpdatingResolver=t),this._changedProperties=new Map,this._saveInstanceProperties(),this.requestUpdateInternal()}_saveInstanceProperties(){this.constructor._classProperties.forEach((t,e)=>{if(this.hasOwnProperty(e)){const t=this[e];delete this[e],this._instanceProperties||(this._instanceProperties=new Map),this._instanceProperties.set(e,t)}})}_applyInstanceProperties(){this._instanceProperties.forEach((t,e)=>this[e]=t),this._instanceProperties=void 0}connectedCallback(){this.enableUpdating()}enableUpdating(){void 0!==this._enableUpdatingResolver&&(this._enableUpdatingResolver(),this._enableUpdatingResolver=void 0)}disconnectedCallback(){}attributeChangedCallback(t,e,s){e!==s&&this._attributeToProperty(t,s)}_propertyToAttribute(t,e,s=W){const i=this.constructor,r=i._attributeNameForProperty(t,s);if(void 0!==r){const t=i._propertyValueToAttribute(e,s);if(void 0===t)return;this._updateState=8|this._updateState,null==t?this.removeAttribute(r):this.setAttribute(r,t),this._updateState=-9&this._updateState}}_attributeToProperty(t,e){if(8&this._updateState)return;const s=this.constructor,i=s._attributeToPropertyMap.get(t);if(void 0!==i){const t=s.getPropertyOptions(i);this._updateState=16|this._updateState,this[i]=s._propertyValueFromAttribute(e,t),this._updateState=-17&this._updateState}}requestUpdateInternal(t,e,s){let i=!0;if(void 0!==t){const r=this.constructor;s=s||r.getPropertyOptions(t),r._valueHasChanged(this[t],e,s.hasChanged)?(this._changedProperties.has(t)||this._changedProperties.set(t,e),!0!==s.reflect||16&this._updateState||(void 0===this._reflectingProperties&&(this._reflectingProperties=new Map),this._reflectingProperties.set(t,s))):i=!1}!this._hasRequestedUpdate&&i&&(this._updatePromise=this._enqueueUpdate())}requestUpdate(t,e){return this.requestUpdateInternal(t,e),this.updateComplete}async _enqueueUpdate(){this._updateState=4|this._updateState;try{await this._updatePromise}catch(t){}const t=this.performUpdate();return null!=t&&await t,!this._hasRequestedUpdate}get _hasRequestedUpdate(){return 4&this._updateState}get hasUpdated(){return 1&this._updateState}performUpdate(){if(!this._hasRequestedUpdate)return;this._instanceProperties&&this._applyInstanceProperties();let t=!1;const e=this._changedProperties;try{t=this.shouldUpdate(e),t?this.update(e):this._markUpdated()}catch(e){throw t=!1,this._markUpdated(),e}t&&(1&this._updateState||(this._updateState=1|this._updateState,this.firstUpdated(e)),this.updated(e))}_markUpdated(){this._changedProperties=new Map,this._updateState=-5&this._updateState}get updateComplete(){return this._getUpdateComplete()}_getUpdateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._updatePromise}shouldUpdate(t){return!0}update(t){void 0!==this._reflectingProperties&&this._reflectingProperties.size>0&&(this._reflectingProperties.forEach((t,e)=>this._propertyToAttribute(e,this[e],t)),this._reflectingProperties=void 0),this._markUpdated()}updated(t){}firstUpdated(t){}}J[K]=!0;const Y=window.ShadowRoot&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,X=Symbol();class G{constructor(t,e){if(e!==X)throw new Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t}get styleSheet(){return void 0===this._styleSheet&&(Y?(this._styleSheet=new CSSStyleSheet,this._styleSheet.replaceSync(this.cssText)):this._styleSheet=null),this._styleSheet}toString(){return this.cssText}}(window.litElementVersions||(window.litElementVersions=[])).push("2.5.1");const Z={};class Q extends J{static getStyles(){return this.styles}static _getUniqueStyles(){if(this.hasOwnProperty(JSCompiler_renameProperty("_styles",this)))return;const t=this.getStyles();if(Array.isArray(t)){const e=(t,s)=>t.reduceRight((t,s)=>Array.isArray(s)?e(s,t):(t.add(s),t),s),s=e(t,new Set),i=[];s.forEach(t=>i.unshift(t)),this._styles=i}else this._styles=void 0===t?[]:[t];this._styles=this._styles.map(t=>{if(t instanceof CSSStyleSheet&&!Y){const e=Array.prototype.slice.call(t.cssRules).reduce((t,e)=>t+e.cssText,"");return new G(String(e),X)}return t})}initialize(){super.initialize(),this.constructor._getUniqueStyles(),this.renderRoot=this.createRenderRoot(),window.ShadowRoot&&this.renderRoot instanceof window.ShadowRoot&&this.adoptStyles()}createRenderRoot(){return this.attachShadow(this.constructor.shadowRootOptions)}adoptStyles(){const t=this.constructor._styles;0!==t.length&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow?Y?this.renderRoot.adoptedStyleSheets=t.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet):this._needsShimAdoptedStyleSheets=!0:window.ShadyCSS.ScopingShim.prepareAdoptedCssText(t.map(t=>t.cssText),this.localName))}connectedCallback(){super.connectedCallback(),this.hasUpdated&&void 0!==window.ShadyCSS&&window.ShadyCSS.styleElement(this)}update(t){const e=this.render();super.update(t),e!==Z&&this.constructor.render(e,this.renderRoot,{scopeName:this.localName,eventContext:this}),this._needsShimAdoptedStyleSheets&&(this._needsShimAdoptedStyleSheets=!1,this.constructor._styles.forEach(t=>{const e=document.createElement("style");e.textContent=t.cssText,this.renderRoot.appendChild(e)}))}render(){return Z}}Q.finalized=!0,Q.render=(t,s,i)=>{if(!i||"object"!=typeof i||!i.scopeName)throw new Error("The `scopeName` option is required.");const r=i.scopeName,n=R.has(s),a=O&&11===s.nodeType&&!!s.host,o=a&&!z.has(r),l=o?document.createDocumentFragment():s;if(((t,s,i)=>{let r=R.get(s);void 0===r&&(e(s,s.firstChild),R.set(s,r=new E(Object.assign({templateFactory:N},i))),r.appendInto(s)),r.setValue(t),r.commit()})(t,l,Object.assign({templateFactory:H(r)},i)),o){const t=R.get(l);R.delete(l);const i=t.value instanceof w?t.value.template:void 0;F(r,l,i),e(s,s.firstChild),s.appendChild(l),R.set(s,t)}!n&&a&&window.ShadyCSS.styleElement(s.host)},Q.shadowRootOptions={mode:"open"};const tt=((t,...e)=>{const s=e.reduce((e,s,i)=>e+(t=>{if(t instanceof G)return t.cssText;if("number"==typeof t)return t;throw new Error(`Value passed to 'css' function must be a 'css' function result: ${t}. Use 'unsafeCSS' to pass non-literal values, but\n            take care to ensure page security.`)})(s)+t[i+1],t[0]);return new G(s,X)})`
  ha-card {
    padding: 16px;
    height: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }
  
  .card-content {
    flex-grow: 1;
    position: relative;
    display: flex;
    flex-direction: column;
  }
  
  .chart-container {
    position: relative;
    flex-grow: 1;
    min-height: 300px;
    user-select: none;
    outline: none;
  }
  
  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    font-size: 14px;
    color: var(--primary-text-color);
  }
  
  .selection-rect {
    position: absolute;
    border: 2px dashed var(--primary-color, #03a9f4);
    background: rgba(3, 169, 244, 0.15);
    display: none;
    pointer-events: none;
    z-index: 20;
    border-radius: 4px;
  }
  
  canvas {
    cursor: ns-resize;
    touch-action: none;
  }
  
  .drag-value-display {
    position: absolute;
    top: 0;
    left: 0;
    background: var(--card-background-color, white);
    border: 1px solid var(--divider-color, #e0e0e0);
    padding: 4px 8px;
    border-radius: 4px;
    display: none;
    z-index: 100;
    font-size: 12px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
  }
  
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 16px;
    align-items: center;
    padding-top: 12px;
    border-top: 1px solid var(--divider-color, #e0e0e0);
  }
  
  .control-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .control-group span {
    font-size: 14px;
    color: var(--primary-text-color);
  }
  
  ha-select {
    min-width: 180px;
  }
  
  mwc-button {
    --mdc-theme-primary: var(--primary-color);
  }
  
  .unsaved-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--warning-color, #ff9800);
  }
  
  @media (max-width: 600px) {
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .control-group {
      width: 100%;
      justify-content: space-between;
    }
    
    ha-select {
      width: 100%;
    }
  }
`,et={title:"Temperature Scheduler",entity_prefix:"temperature_hour_",chartjs_path:"/local/chart.min.js",dragdata_path:"/local/chartjs-plugin-dragdata.min.js",pause_entity:"input_boolean.temperature_schedule_paused",profiles_select_entity:"input_select.temperature_profiles",save_script:"script.save_temperature_profile",load_script:"script.load_temperature_profile",hour_base:"auto"},st=0,it=50,rt=15,nt=30,at=.5,ot=5,lt=8,ct=10,dt=2,ht=.4,ut="rgba(3, 169, 244, 1)",pt="rgba(3, 169, 244, 0.2)",gt="red",yt="darkred",ft="#ff5252",mt="#b71c1c",wt=3e3,vt=600,St=500,_t=1e3;function Pt(t,e=1){const s=Math.pow(10,e);return Math.round(t*s)/s}function xt(t,e,s){return Math.max(e,Math.min(s,t))}function bt(t,e=0){return(t+e).toString().padStart(2,"0")}function Ct(t,e=null){const s=parseFloat(t);return Number.isNaN(s)?e:s}const Et={log:(t,...e)=>console.log(`[${t}]`,...e),warn:(t,...e)=>console.warn(`[${t}]`,...e),error:(t,...e)=>console.error(`[${t}]`,...e),state:(...t)=>Et.log("STATE",...t),load:(...t)=>Et.log("LOAD",...t),save:(...t)=>Et.log("SAVE",...t),sel:(...t)=>Et.log("SEL",...t),memo:(...t)=>Et.log("MEMO",...t),diff:(...t)=>Et.log("DIFF",...t),key:(...t)=>Et.log("KEY",...t),base:(...t)=>Et.log("BASE",...t)};class At{constructor(t){this.card=t,this.scheduleData=new Array(24).fill(null),this.dirtyIndices=new Set,this.isLoadingProfile=!1}updateFromHass(t){const e=[];let s=!1;for(let i=0;i<24;i++){const r=this.getEntityIdForHour(i),n=t.states[r];let a=n?Ct(n.state):null;this.scheduleData[i]!==a&&(s=!0),e[i]=a}return s&&!this.isLoadingProfile?(Et.state("Schedule data updated from hass. Hours 00-05:",e.slice(0,6)),this.scheduleData=e,!0):!(!s||!this.isLoadingProfile)&&(Et.state("Update ignored during profile loading"),!1)}getEntityIdForHour(t){return`input_number.${this.card.config.entity_prefix}${bt(t,this.card.hourBase)}`}getHourLabel(t){return`${bt(t,this.card.hourBase)}:00`}updateTemperatureAtHour(t,e){const s=this.getEntityIdForHour(t);Et.memo(`set_value call -> entity=${s} hour=${this.getHourLabel(t)} value=${e}`),this.card.hass.callService("input_number","set_value",{entity_id:s,value:e}),this.dirtyIndices.add(t),this.card.hasUnsavedChanges=!0}async waitForEntityNumericState(t,e,s=3e3,i=.001){const r=Date.now();return new Promise((n,a)=>{const o=()=>{const l=this.card.hass?.states?.[t]?.state,c=Ct(l);return null!==c&&Math.abs(c-e)<=i?(Et.memo(`State confirmed -> entity=${t}, expected=${e}, current=${c}`),void n()):Date.now()-r>s?(Et.warn("MEMO",`Timeout waiting for ${t}. Expected: ${e}, current: ${c}`),void a(new Error(`Timeout waiting for ${t}`))):void setTimeout(o,100)};o()})}async ensureValuesApplied(){const t=[];Et.memo("Ensuring values applied. Dirty indices:",Array.from(this.dirtyIndices));for(const e of Array.from(this.dirtyIndices)){const s=this.getEntityIdForHour(e),i=this.scheduleData[e];null!==i&&(Et.memo(`Waiting for entity sync -> hour=${this.getHourLabel(e)}, entity=${s}, expected=${i}`),t.push(this.waitForEntityNumericState(s,i,4e3,.001).catch(t=>Et.warn("MEMO",`Wait failed for ${s}:`,t))))}t.length>0&&await Promise.all(t),this.dirtyIndices.clear()}logPersistedValues(t,e){e.forEach(e=>{const s=this.getEntityIdForHour(e),i=this.getHourLabel(e),r=this.scheduleData[e];Et.memo(`${t} -> hour=${i}, entity=${s}, value=${r}`)})}clearDirty(){this.dirtyIndices.clear()}getData(){return[...this.scheduleData]}setData(t){this.scheduleData=[...t]}}class Mt{constructor(t){this.card=t,this.lastLoadedProfile=""}async waitForEntityState(t,e,s=wt){const i=Date.now();return new Promise((r,n)=>{const a=()=>{const o=this.card.hass?.states?.[t]?.state;o!==e?Date.now()-i>s?n(new Error(`Timeout waiting for ${t} to become '${e}', current: '${o}'`)):setTimeout(a,100):r()};a()})}async saveProfile(t=this.lastLoadedProfile){if(!t)throw Et.warn("SAVE","No profile specified"),new Error("No profile specified for saving");const e=this.card.config.save_script.startsWith("script.")?this.card.config.save_script.substring(7):this.card.config.save_script;Et.save(`Invoking script '${e}' for profile '${t}'`),Et.save(`Parameters: entity_prefix='${this.card.config.entity_prefix}', hour_base=${this.card.hourBase}`);try{await this.card.hass.callService("script",e,{profile_name:t,entity_prefix:this.card.config.entity_prefix,hour_base:this.card.hourBase,payload_version:2}),this.card.hasUnsavedChanges=!1,this.lastLoadedProfile=t,Et.save(`Script '${e}' completed for profile '${t}'`)}catch(s){throw Et.error("SAVE",`Error calling save script '${e}':`,s),alert(`Error saving profile '${t}'. Check console for details.`),s}}async loadProfile(t){this.card.stateManager.isLoadingProfile=!0;const e=[...this.card.stateManager.scheduleData];Et.load("PRE-load schedule data (00..05):",e.slice(0,6));const s=this.card.config.load_script.startsWith("script.")?this.card.config.load_script.substring(7):this.card.config.load_script;Et.load(`Invoking script '${s}' for profile '${t}'`),Et.load(`Parameters: entity_prefix='${this.card.config.entity_prefix}', hour_base=${this.card.hourBase}`);try{await this.card.hass.callService("script",s,{profile_name:t,entity_prefix:this.card.config.entity_prefix,hour_base:this.card.hourBase,payload_version:2}),Et.load("Script completed, waiting for state propagation..."),await new Promise(t=>setTimeout(t,vt));const i=[];for(let t=0;t<24;t++){const e=this.card.stateManager.getEntityIdForHour(t),s=this.card.hass.states[e];let r=s?Ct(s.state):null;i[t]=r}Et.load("POST-load values read (00..05):",i.slice(0,6)),Et.load("POST-load values read (10..15):",i.slice(10,16));for(let t=0;t<24;t++)e[t]!==i[t]&&Et.diff(`idx=${t} hour=${this.card.stateManager.getHourLabel(t)}: ${e[t]} -> ${i[t]}`);this.card.stateManager.setData(i),this.card.chartManager&&this.card.chartManager.isInitialized()&&(this.card.chartManager.updateData(i),Et.load("Chart updated with new data")),this.card.hasUnsavedChanges=!1,this.lastLoadedProfile=t,Et.load(`Profile '${t}' loaded completely`)}catch(e){throw Et.error("LOAD",`Error calling load script '${s}':`,e),alert(`Error loading profile '${t}'. Check console for details.`),e}finally{this.card.stateManager.isLoadingProfile=!1}}async handleProfileSelection(t){this.card.suppressClickUntil=Date.now()+_t+500,this.card.selectionManager&&this.card.selectionManager.snapshotSelection();const e=t?.target?.value||t?.detail?.value||"";if(!e||e===this.card.selectedProfile)return;const s=this.lastLoadedProfile||this.card.selectedProfile;if(this.card.hasUnsavedChanges&&s)try{Et.save(`Auto-saving previous profile '${s}' before switching`),await this.card.stateManager.ensureValuesApplied(),this.card.stateManager.logPersistedValues(`auto-save profile '${s}'`,Array.from(this.card.stateManager.dirtyIndices)),await this.saveProfile(s),Et.save(`Auto-save of '${s}' completed`)}catch(t){Et.error("SAVE","Error during auto-save:",t)}this.card.selectedProfile=e;try{await this.card.hass.callService("input_select","select_option",{entity_id:this.card.config.profiles_select_entity,option:e}),await this.waitForEntityState(this.card.config.profiles_select_entity,e,wt)}catch(t){Et.warn("LOAD","select_option or wait failed:",t)}try{await this.loadProfile(e),this.card.selectionManager&&this.card.selectionManager.restoreSelectionFromSnapshot(),this.card.suppressClickUntil=Date.now()+St}catch(t){Et.error("LOAD","Error during auto-load:",t)}}async resetChanges(){const t=this.lastLoadedProfile||this.card.selectedProfile;if(t){this.card.selectionManager&&this.card.selectionManager.snapshotSelection();try{await this.loadProfile(t),this.card.selectionManager&&this.card.selectionManager.restoreSelectionFromSnapshot()}catch(t){Et.error("LOAD","Error while reloading profile:",t)}}else Et.warn("LOAD","No profile to reload")}}class Dt{constructor(t){this.card=t,this.selectedPoint=null,this.selectedPoints=[],this.selectionSnapshot=null}selectIndices(t,e=!0){const s=(i=t,[...new Set(i)]).filter(t=>t>=0&&t<24);var i;this.selectedPoints=s,e&&null!==this.selectedPoint&&this.selectedPoints.includes(this.selectedPoint)||(this.selectedPoint=this.selectedPoints.length>0?this.selectedPoints[0]:null),this.logSelection("selectIndices")}toggleIndexSelection(t){const e=new Set(this.selectedPoints);e.has(t)?e.delete(t):e.add(t),this.selectedPoints=Array.from(e),null!==this.selectedPoint&&this.selectedPoints.includes(this.selectedPoint)||(this.selectedPoint=this.selectedPoints.length>0?this.selectedPoints[0]:null),this.logSelection("toggleIndexSelection")}clearSelection(){this.selectedPoints=[],this.selectedPoint=null,Et.sel("Selection cleared")}snapshotSelection(){Array.isArray(this.selectedPoints)&&this.selectedPoints.length>0?(this.selectionSnapshot={points:[...this.selectedPoints],anchor:this.selectedPoint},this.logSelection("snapshot before profile change")):(this.selectionSnapshot=null,Et.sel("Snapshot: no active selection"))}restoreSelectionFromSnapshot(){if(!this.selectionSnapshot)return void Et.sel("Restore: no snapshot to restore");const t=Array.isArray(this.selectionSnapshot.points)?[...this.selectionSnapshot.points]:[];this.selectedPoints=t.filter(t=>t>=0&&t<24),null!==this.selectionSnapshot.anchor&&t.includes(this.selectionSnapshot.anchor)?this.selectedPoint=this.selectionSnapshot.anchor:this.selectedPoint=this.selectedPoints.length>0?this.selectedPoints[0]:null,this.card.chartManager&&this.card.chartManager.updatePointStyling(this.selectedPoint,this.selectedPoints),this.logSelection("restore selection after profile change")}logSelection(t=""){const e=null!==this.selectedPoint?this.card.stateManager.getHourLabel(this.selectedPoint):"n/a";if(Et.sel(`${t} - anchor=${this.selectedPoint} (${e}) points=${JSON.stringify(this.selectedPoints)}`),this.card.stateManager){const t=this.card.stateManager.scheduleData;this.selectedPoints.forEach(e=>{const s=this.card.stateManager.getHourLabel(e),i=this.card.stateManager.getEntityIdForHour(e),r=t[e],n=this.card.hass?.states?.[i],a=n?n.state:void 0;Et.sel(`  idx=${e}, hour=${s}, entity=${i}, chartVal=${r}, entityState=${a}`)})}}getActiveIndices(){return Array.isArray(this.selectedPoints)&&this.selectedPoints.length>0?[...this.selectedPoints]:null!==this.selectedPoint?[this.selectedPoint]:[]}isSelected(t){return this.selectedPoints.includes(t)}isAnchor(t){return this.selectedPoint===t}setAnchor(t){this.selectedPoints.includes(t)&&(this.selectedPoint=t)}getAnchor(){return this.selectedPoint}getSelectedPoints(){return[...this.selectedPoints]}}let $t=!1;class It{constructor(t){this.card=t,this.chart=null,this.chartInitialized=!1,this.dragStartValues=null,this.dragAnchorIndex=null}async loadPlugins(){if($t)return!0;try{window.Chart||await(t=this.card.config.chartjs_path,new Promise((e,s)=>{if(document.querySelector(`script[src="${t}"]`))return void e();const i=document.createElement("script");i.src=t,i.onload=e,i.onerror=()=>s(new Error(`Failed to load script: ${t}`)),document.head.appendChild(i)}));let e=window.ChartJSdragDataPlugin;if(!e)try{const t=await import(this.card.config.dragdata_path);e=t.default||t}catch(t){e=window.ChartJSdragDataPlugin||window.ChartDataDrag||void 0}if(window.Chart&&e)return window.Chart.register(e),$t=!0,Et.log("CHART","chartjs-plugin-dragdata registered"),!0;if(window.Chart)return $t=!0,Et.warn("CHART","dragdata plugin not found; proceeding"),!0;throw new Error("Chart.js could not be resolved")}catch(t){return Et.error("CHART","Error loading chart libraries:",t),!1}var t}async initChart(t){if(!await this.loadPlugins())return!1;const e=t.getContext("2d");return!!e&&(this.chart=new window.Chart(e,{type:"line",data:{labels:Array.from({length:24},(t,e)=>`${e.toString().padStart(2,"0")}:00`),datasets:[{label:"Temperatura (°C)",data:this.card.stateManager.scheduleData,backgroundColor:pt,borderColor:ut,borderWidth:dt,pointRadius:ot,pointHoverRadius:lt,pointHitRadius:ct,fill:!0,tension:ht}]},options:this.getChartOptions()}),this.chartInitialized=!0,this.updatePointStyling(this.card.selectionManager?.selectedPoint,this.card.selectionManager?.selectedPoints),this.chart.update(),Et.log("CHART","Chart initialized successfully"),!0)}getChartOptions(){return{responsive:!0,maintainAspectRatio:!1,events:["mousemove","mouseout","click","touchstart","touchmove","touchend","pointermove","pointerdown","pointerup","mousedown","mouseup"],scales:{y:{beginAtZero:!1,suggestedMin:rt,suggestedMax:nt,title:{display:!0,text:"Temperatura (°C)"}},x:{title:{display:!0,text:"Ora del Giorno"}}},onClick:t=>this.handleChartClick(t),plugins:{dragData:this.getDragDataOptions(),tooltip:{enabled:!0}}}}getDragDataOptions(){return{round:at,dragX:!1,onDragStart:(t,e,s,i)=>{if(this.card.pointerHandler?.isSelecting)return!1;const r=this.card.selectionManager;if(!r)return!1;r.isSelected(s)?r.setAnchor(s):r.selectIndices([s],!1),this.dragStartValues={};const n=this.chart.data.datasets[0].data;return r.getSelectedPoints().forEach(t=>{this.dragStartValues[t]=n[t]??this.card.stateManager.scheduleData[t]}),this.dragAnchorIndex=s,this.updatePointStyling(r.selectedPoint,r.selectedPoints),r.logSelection("onDragStart"),!0},onDrag:(t,e,s,i)=>{if(!this.dragStartValues||null===this.dragAnchorIndex)return;const r=i-this.dragStartValues[this.dragAnchorIndex],n=this.chart.data.datasets[0],a=this.card.selectionManager;a.getSelectedPoints().forEach(t=>{let e=this.dragStartValues[t]+r;e=xt(e,st,it),e=Pt(e,1),n.data[t]=e}),this.chart.update("none"),this.showDragValueDisplay(a.getSelectedPoints(),n.data)},onDragEnd:(t,e,s,i)=>{const r=this.card.shadowRoot?.getElementById("myChart");r&&(r.style.cursor="default");const n=this.chart.data.datasets[0],a=this.card.selectionManager,o=this.card.stateManager,l=a.getActiveIndices(),c=[...o.scheduleData];l.forEach(t=>{let e=n.data[t];e=Pt(e,1),c[t]=e}),o.setData(c),o.logPersistedValues("dragEnd",l),l.forEach(t=>{o.updateTemperatureAtHour(t,c[t])}),a.setAnchor(s),this.updatePointStyling(a.selectedPoint,a.selectedPoints),this.hideDragValueDisplay(),this.dragStartValues=null,this.dragAnchorIndex=null}}}handleChartClick(t){if(Date.now()<this.card.suppressClickUntil)return;const e=this.chart.getElementsAtEventForMode(t,"nearest",{intersect:!0},!0),s=!!(this.card.keyboardHandler?.ctrlDown||this.card.keyboardHandler?.metaDown||t.ctrlKey||t.metaKey),i=this.card.selectionManager;if(e.length){const t=e[0].index;s?i.toggleIndexSelection(t):i.selectIndices([t],!0)}else s||i.clearSelection();this.updatePointStyling(i.selectedPoint,i.selectedPoints),this.chartInitialized&&this.chart.update(),i.logSelection("onClick")}updatePointStyling(t,e=[]){if(!this.chartInitialized||!this.chart?.data?.datasets?.length)return;const s=this.chart.data.datasets[0],i=Array.isArray(s.data)?s.data.length:24;s.pointRadius=Array(i).fill(ot),s.pointBackgroundColor=Array(i).fill(ut),s.pointBorderColor=Array(i).fill(ut),s.pointBorderWidth=Array(i).fill(dt),Array.isArray(e)&&e.length>0&&e.forEach(t=>{t>=0&&t<i&&(s.pointRadius[t]=8,s.pointBackgroundColor[t]=gt,s.pointBorderColor[t]=yt,s.pointBorderWidth[t]=2)}),null!==t&&t>=0&&t<i&&(s.pointRadius[t]=9,s.pointBorderWidth[t]=3,s.pointBackgroundColor[t]=ft,s.pointBorderColor[t]=mt)}showDragValueDisplay(t,e){const s=this.card.shadowRoot?.getElementById("drag-value-display");if(!s||0===t.length)return;const i=Math.min(...t),r=e[i];s.style.display="block",s.textContent=`Valore: ${r}°C`;const n=this.chart.getDatasetMeta(0).data[i];if(n){const{x:t,y:e}=n.tooltipPosition(),{x:i,y:r}=this.getContainerRelativePointCoords(t,e);s.style.left=`${i+10}px`,s.style.top=r-30+"px"}}hideDragValueDisplay(){const t=this.card.shadowRoot?.getElementById("drag-value-display");t&&(t.style.display="none")}getContainerRelativePointCoords(t,e){const s=this.card.shadowRoot?.querySelector(".chart-container"),i=this.card.shadowRoot?.getElementById("myChart");if(!s||!i)return{x:0,y:0};const r=s.getBoundingClientRect(),n=i.getBoundingClientRect();return{x:t+(n.left-r.left),y:e+(n.top-r.top)}}updateData(t){this.chartInitialized&&this.chart&&(this.chart.data.datasets[0].data=[...t],this.updatePointStyling(this.card.selectionManager?.selectedPoint,this.card.selectionManager?.selectedPoints),this.chart.update())}destroy(){this.chart&&(this.chart.destroy(),this.chart=null,this.chartInitialized=!1)}isInitialized(){return this.chartInitialized&&null!==this.chart}update(){this.chartInitialized&&this.chart&&this.chart.update()}getChart(){return this.chart}}class kt{constructor(t){this.card=t,this.ctrlDown=!1,this.metaDown=!1,this.enabled=!0,this.handleKeydown=this.handleKeydown.bind(this),this.handleKeyup=this.handleKeyup.bind(this)}enable(){this.enabled=!0}disable(){this.enabled=!1}handleKeydown(t){if(!this.enabled)return;if("Control"===t.key)return void(this.ctrlDown=!0);if("Meta"===t.key)return void(this.metaDown=!0);if("Escape"===t.key)return void this.handleEscape();const e=this.card.selectionManager.getActiveIndices();0!==e.length&&("ArrowLeft"!==t.key&&"ArrowRight"!==t.key?"ArrowUp"!==t.key&&"ArrowDown"!==t.key||this.handleArrowUpDown(t,e):this.handleArrowLeftRight(t,e))}handleKeyup(t){"Control"!==t.key?"Meta"!==t.key?"ArrowUp"!==t.key&&"ArrowDown"!==t.key&&"ArrowLeft"!==t.key&&"ArrowRight"!==t.key||this.card.chartManager?.hideDragValueDisplay():this.metaDown=!1:this.ctrlDown=!1}handleEscape(){this.card.selectionManager.clearSelection(),this.card.chartManager?.updatePointStyling(null,[]),this.card.chartManager?.update()}handleArrowLeftRight(t,e){t.preventDefault();const s=this.card.selectionManager,i=this.card.stateManager,r=this.card.chartManager,n=s.getAnchor()??e[0],a=r.chart.data.datasets[0],o=Pt(a.data[n]??i.scheduleData[n],1);Et.key(`${t.key} -> align to anchor: idx=${n} (${i.getHourLabel(n)}) value=${o} indices=${JSON.stringify(e)}`);const l=[...i.scheduleData];e.forEach(t=>{l[t]=o,a.data[t]=o,i.updateTemperatureAtHour(t,o)}),i.setData(l),r.updatePointStyling(s.selectedPoint,s.selectedPoints),r.update(),r.showDragValueDisplay(e,a.data)}handleArrowUpDown(t,e){t.preventDefault();const s="ArrowUp"===t.key?at:-.5,i=this.card.selectionManager,r=this.card.stateManager,n=this.card.chartManager,a=n.chart.data.datasets[0],o=[...r.scheduleData];Et.key(`${t.key} -> delta=${s} indices=${JSON.stringify(e)}`),e.forEach(t=>{let e=(a.data[t]??r.scheduleData[t])+s;e=xt(e,st,it),e=Pt(e,1),a.data[t]=e,o[t]=e,r.updateTemperatureAtHour(t,e)}),r.setData(o),n.updatePointStyling(i.selectedPoint,i.selectedPoints),n.update(),n.showDragValueDisplay(e,a.data)}attachListeners(t){t.addEventListener("keydown",this.handleKeydown),t.addEventListener("keyup",this.handleKeyup)}detachListeners(t){t.removeEventListener("keydown",this.handleKeydown),t.removeEventListener("keyup",this.handleKeyup)}}class Nt{constructor(t){this.card=t,this.isSelecting=!1,this.selStartPx=null,this.selEndPx=null,this.activePointerId=null,this.selectionAdditive=!1,this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this),this.onPointerCancel=this.onPointerCancel.bind(this)}getContainerRelativeCoords(t){const e=this.card.shadowRoot?.querySelector(".chart-container");if(!e)return{x:0,y:0};const s=e.getBoundingClientRect();return{x:t.clientX-s.left,y:t.clientY-s.top}}showSelectionOverlay(){const t=this.card.shadowRoot?.getElementById("selection-rect");t&&(t.style.display="block",this.updateSelectionOverlay())}hideSelectionOverlay(){const t=this.card.shadowRoot?.getElementById("selection-rect");t&&(t.style.display="none")}updateSelectionOverlay(){const t=this.card.shadowRoot?.getElementById("selection-rect");if(!t||!this.selStartPx||!this.selEndPx)return;const e=Math.min(this.selStartPx.x,this.selEndPx.x),s=Math.min(this.selStartPx.y,this.selEndPx.y),i=Math.max(this.selStartPx.x,this.selEndPx.x),r=Math.max(this.selStartPx.y,this.selEndPx.y);t.style.left=`${e}px`,t.style.top=`${s}px`,t.style.width=`${Math.max(0,i-e)}px`,t.style.height=`${Math.max(0,r-s)}px`}getIndicesInSelectionRect(){const t=this.card.chartManager;if(!t?.chart||!this.selStartPx||!this.selEndPx)return[];const e=t.chart.getDatasetMeta(0);if(!e?.data)return[];const s=this.card.shadowRoot?.querySelector(".chart-container"),i=this.card.shadowRoot?.getElementById("myChart");if(!s||!i)return[];const r=s.getBoundingClientRect(),n=i.getBoundingClientRect(),a=n.left-r.left,o=n.top-r.top,l=Math.min(this.selStartPx.x,this.selEndPx.x),c=Math.min(this.selStartPx.y,this.selEndPx.y),d=Math.max(this.selStartPx.x,this.selEndPx.x),h=Math.max(this.selStartPx.y,this.selEndPx.y),u=[];return e.data.forEach((t,e)=>{const s="function"==typeof t.tooltipPosition?t.tooltipPosition():{x:t.x,y:t.y},i=s.x+a,r=s.y+o;i>=l&&i<=d&&r>=c&&r<=h&&u.push(e)}),Et.sel(`Area selection: nodes in rectangle -> ${JSON.stringify(u)}`),u}onPointerDown(t){if("mouse"===t.pointerType&&0!==t.button)return;const e=this.card.chartManager,s=(e?.chart?.getElementsAtEventForMode?.(t,"nearest",{intersect:!0},!0)||[]).length>0;if(!(!!t.shiftKey||!s))return;t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation&&t.stopImmediatePropagation(),this.isSelecting=!0,this.activePointerId=t.pointerId,this.selectionAdditive=!!(this.card.keyboardHandler?.ctrlDown||this.card.keyboardHandler?.metaDown||t.ctrlKey||t.metaKey);const i=this.card.shadowRoot?.getElementById("myChart");try{i?.setPointerCapture(t.pointerId)}catch(t){}const{x:r,y:n}=this.getContainerRelativeCoords(t);this.selStartPx={x:r,y:n},this.selEndPx={x:r,y:n},this.showSelectionOverlay(),this.card.suppressClickUntil=Date.now()+St}onPointerMove(t){if(!this.isSelecting)return;if(null!==this.activePointerId&&t.pointerId!==this.activePointerId)return;t.preventDefault();const e=this.getContainerRelativeCoords(t);this.selEndPx=e,this.updateSelectionOverlay()}onPointerUp(t){if(!this.isSelecting)return;if(null!==this.activePointerId&&t.pointerId!==this.activePointerId)return;this.isSelecting=!1,this.activePointerId=null;const e=this.card.shadowRoot?.getElementById("myChart");try{e?.releasePointerCapture(t.pointerId)}catch(t){}this.hideSelectionOverlay();const s=this.getIndicesInSelectionRect(),i=this.card.selectionManager,r=this.card.chartManager;if(s.length>0)if(this.selectionAdditive){const t=[...i.getSelectedPoints()];s.forEach(e=>{t.includes(e)||t.push(e)}),i.selectIndices(t,!0)}else i.selectIndices(s,!0);else i.clearSelection();r.updatePointStyling(i.selectedPoint,i.selectedPoints),r.update(),i.logSelection("area selection completed"),this.card.suppressClickUntil=Date.now()+St}onPointerCancel(){this.isSelecting&&(this.isSelecting=!1,this.activePointerId=null,this.hideSelectionOverlay(),this.card.suppressClickUntil=Date.now()+300)}attachListeners(t){t.addEventListener("pointerdown",this.onPointerDown,{passive:!1,capture:!0}),window.addEventListener("pointermove",this.onPointerMove,!0),window.addEventListener("pointerup",this.onPointerUp,!0),window.addEventListener("pointercancel",this.onPointerCancel,!0)}detachListeners(t){t.removeEventListener("pointerdown",this.onPointerDown,{capture:!0}),window.removeEventListener("pointermove",this.onPointerMove,!0),window.removeEventListener("pointerup",this.onPointerUp,!0),window.removeEventListener("pointercancel",this.onPointerCancel,!0)}}class Tt extends Q{static get properties(){return{hass:{type:Object},config:{type:Object},isPaused:{type:Boolean},selectedProfile:{type:String},profileOptions:{type:Array},hasUnsavedChanges:{type:Boolean}}}static get styles(){return tt}constructor(){super(),this.config=null,this.hourBase=0,this.hourBaseDetermined=!1,this.isPaused=!1,this.selectedProfile="",this.profileOptions=[],this.hasUnsavedChanges=!1,this.suppressClickUntil=0,this.stateManager=new At(this),this.profileManager=new Mt(this),this.selectionManager=new Dt(this),this.chartManager=new It(this),this.keyboardHandler=new kt(this),this.pointerHandler=new Nt(this)}setConfig(t){this.config=function(t){if(!t.entity_prefix)throw new Error("Configuration error: entity_prefix is required");const e={...et,...t};return e.hour_base=function(t){if(0===t||1===t)return{value:t,determined:!0};if("string"==typeof t){const e=t.trim().toLowerCase();if("0"===e||"zero"===e||"00"===e)return{value:0,determined:!0};if("1"===e||"one"===e||"01"===e)return{value:1,determined:!0}}return{value:0,determined:!1}}(t.hour_base),e}(t);const e=this.config.hour_base;"object"==typeof e&&(this.hourBase=e.value,this.hourBaseDetermined=e.determined)}static getStubConfig(){return{...et}}detectHourBase(t){if(this.hourBaseDetermined)return;const e=this.config.entity_prefix;let s=0,i=0;for(let i=0;i<24;i++){const r=`input_number.${e}${i.toString().padStart(2,"0")}`;void 0!==t.states[r]&&s++}for(let s=1;s<=24;s++){const r=`input_number.${e}${s.toString().padStart(2,"0")}`;void 0!==t.states[r]&&i++}this.hourBase=i>s?1:0,this.hourBaseDetermined=!0,Et.base(`Hour base detection -> 0-based: ${s}, 1-based: ${i}. Selected: ${this.hourBase} (${0===this.hourBase?"00-23":"01-24"})`)}set hass(t){if(this._hass=t,this.config&&this.config.entity_prefix){this.detectHourBase(t);this.stateManager.updateFromHass(t)&&this.chartManager.isInitialized()&&this.chartManager.updateData(this.stateManager.getData());const e=t.states[this.config.pause_entity];e&&(this.isPaused="on"===e.state);const s=t.states[this.config.profiles_select_entity];s&&(this.selectedProfile=s.state,this.profileOptions=s.attributes.options||[])}}get hass(){return this._hass}togglePause(){this.hass.callService("input_boolean","toggle",{entity_id:this.config.pause_entity})}async firstUpdated(){super.firstUpdated(),await this.initializeCard()}async initializeCard(){const t=this.shadowRoot.getElementById("myChart");if(!t)return void Et.error("INIT","Canvas element not found");if(!await this.chartManager.initChart(t))return void Et.error("INIT","Failed to initialize chart");this.pointerHandler.attachListeners(t);const e=this.shadowRoot.querySelector(".chart-container");e&&(e.setAttribute("tabindex","0"),this.keyboardHandler.attachListeners(e),e.addEventListener("pointerdown",()=>{e.focus(),this.keyboardHandler.enable()})),Et.log("INIT","Card initialized successfully")}disconnectedCallback(){super.disconnectedCallback(),this.chartManager.destroy();const t=this.shadowRoot?.getElementById("myChart");t&&this.pointerHandler.detachListeners(t);const e=this.shadowRoot?.querySelector(".chart-container");e&&this.keyboardHandler.detachListeners(e)}render(){const t=this.stateManager.scheduleData.some(t=>null===t);return V`
      <ha-card header="${this.config.title} (v${"2.18.0"})">
        <div class="card-content">
          <div class="chart-container">
            ${t?V`<div class="loading-overlay"><div>Caricamento dati...</div></div>`:""}
            <canvas id="myChart"></canvas>
            <div id="selection-rect" class="selection-rect"></div>
            <div id="drag-value-display" class="drag-value-display"></div>
          </div>

          <div class="controls">
            <div class="control-group">
              <ha-switch
                .checked=${this.isPaused}
                @change=${this.togglePause}
              ></ha-switch>
              <span>Pausa</span>
            </div>

            <div class="control-group">
              <ha-select
                label="Profilo"
                .value=${this.selectedProfile}
                @selected=${t=>this.profileManager.handleProfileSelection(t)}
                @opened=${()=>{this.keyboardHandler.disable(),this.suppressClickUntil=Date.now()+1e3}}
                @closed=${()=>{this.keyboardHandler.enable();const t=this.shadowRoot.querySelector(".chart-container");t?.focus(),this.suppressClickUntil=Date.now()+500}}
              >
                ${this.profileOptions.map(t=>V`<mwc-list-item .value=${t}>${t}</mwc-list-item>`)}
              </ha-select>
            </div>

            ${this.hasUnsavedChanges?V`
              <div class="control-group">
                <span class="unsaved-indicator">● Modifiche non salvate</span>
                <mwc-button outlined @click=${()=>this.profileManager.resetChanges()}>
                  Reset
                </mwc-button>
              </div>
            `:""}
          </div>
        </div>
      </ha-card>
    `}}customElements.define("temperature-scheduler-card",Tt),window.customCards=window.customCards||[],window.customCards.push({type:"temperature-scheduler-card",name:"Temperature Scheduler Card",description:"Visual temperature schedule editor with drag-and-drop control",preview:!0,documentationURL:"https://github.com/YOUR_USERNAME/temperature-scheduler-card"}),console.info(`%c TEMPERATURE-SCHEDULER-CARD %c v${Tt.VERSION||"2.18.0"} `,"color: white; background: #03a9f4; font-weight: 700;","color: #03a9f4; background: white; font-weight: 700;");
